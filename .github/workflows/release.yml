name: Release

on:
    workflow_dispatch:
        inputs:
            create_tag:
                description: 'Create and push a release tag'
                required: true
                default: true
                type: boolean
            dry_run:
                description: 'Dry run (skip release + store submission)'
                required: true
                default: true
                type: boolean
            release:
                description: 'Create a new version release'
                required: false
                default: false
                type: boolean
    push:
        tags:
            - 'v*.*.*'

env:
    NDK_VERSION: 29.0.13113456

jobs:
    version:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        outputs:
            version: ${{ steps.bump.outputs.version || steps.version_tag.outputs.version || steps.version_pkg.outputs.version }}
            skip_tag_jobs: ${{ steps.skip_tag_jobs.outputs.skip_tag_jobs }}
            checkout_ref: ${{ steps.checkout_ref.outputs.ref }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  fetch-tags: true
                  token: ${{ secrets.RELEASE_TOKEN || github.token }}

            - uses: jdx/mise-action@v3
              with:
                  cache: true
                  cache_key_prefix: 'mise-v1'

            - name: Bump version (for manual release)
              if: ${{ inputs.release && inputs.create_tag && github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/') }}
              id: bump
              run: |
                  pnpm dlx changelogen --bump
                  VERSION=$(node -p "require('./package.json').version")
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Bumped version: $VERSION"

            - name: Sync version files (manual release)
              if: ${{ inputs.release && inputs.create_tag && github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/') }}
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  export VERSION
                  node - <<'NODE'
                  const fs = require('fs')
                  const version = process.env.VERSION

                  const tauri_path = 'src-tauri/tauri.conf.json'
                  const tauri_data = JSON.parse(fs.readFileSync(tauri_path, 'utf8'))
                  tauri_data.version = version
                  fs.writeFileSync(tauri_path, JSON.stringify(tauri_data, null, 4) + '\n')

                  const cargo_path = 'src-tauri/Cargo.toml'
                  const cargo_lines = fs.readFileSync(cargo_path, 'utf8').split('\n')
                  let in_package = false
                  const next_lines = cargo_lines.map((line) => {
                      if (line.startsWith('[')) in_package = line === '[package]'
                      if (in_package && line.startsWith('version = ')) return 'version = "' + version + '"'
                      return line
                  })
                  fs.writeFileSync(cargo_path, next_lines.join('\n'))
                  NODE

            - name: Extract version from tag (tag trigger)
              if: ${{ !inputs.release && startsWith(github.ref, 'refs/tags/') }}
              id: version_tag
              run: |
                  TAG="${GITHUB_REF#refs/tags/}"
                  # Handle both v1.0.0 and 1.0.0 formats
                  if [[ "$TAG" == v* ]]; then
                    VERSION="${TAG#v}"
                  else
                    VERSION="$TAG"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Extracted version: $VERSION"

            - name: Extract version from package.json (manual run without tag)
              if: ${{ github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/') && (!inputs.release || !inputs.create_tag) }}
              id: version_pkg
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Using package.json version: $VERSION"

            - name: Validate version files
              if: ${{ !inputs.release }}
              run: |
                  VERSION="${{ steps.version_tag.outputs.version || steps.version_pkg.outputs.version }}"
                  export VERSION
                  node - <<'NODE'
                  const fs = require('fs')
                  const version = process.env.VERSION

                  const pkg_version = JSON.parse(fs.readFileSync('package.json', 'utf8')).version
                  const tauri_version = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8')).version
                  const cargo_match = fs.readFileSync('src-tauri/Cargo.toml', 'utf8').match(/^version = "(.+)"$/m)
                  const cargo_version = cargo_match ? cargo_match[1] : ''

                  const mismatches = [
                      ['package.json', pkg_version],
                      ['src-tauri/tauri.conf.json', tauri_version],
                      ['src-tauri/Cargo.toml', cargo_version],
                  ].filter(([, file_version]) => file_version !== version)

                  if (mismatches.length) {
                      console.error('Version mismatch for tag ' + version)
                      for (const [file, file_version] of mismatches) {
                          console.error(file + ': ' + file_version)
                      }
                      process.exit(1)
                  }
                  NODE

            - name: Decide whether to skip tag jobs
              id: skip_tag_jobs
              run: |
                  SKIP=false
                  if [[ "$GITHUB_EVENT_NAME" == "push" && "$GITHUB_REF" == refs/tags/* ]]; then
                    COMMIT=$(git rev-list -n 1 "$GITHUB_REF")
                    AUTHOR_NAME=$(git show -s --format=%an "$COMMIT")
                    AUTHOR_EMAIL=$(git show -s --format=%ae "$COMMIT")
                    if [[ "$AUTHOR_NAME" == "github-actions[bot]" || "$AUTHOR_EMAIL" == "github-actions@users.noreply.github.com" ]]; then
                      SKIP=true
                    fi
                  fi
                  echo "skip_tag_jobs=$SKIP" >> $GITHUB_OUTPUT
                  echo "Skip tag jobs: $SKIP"

            - name: Generate changelog
              if: ${{ inputs.release && inputs.create_tag && github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/') }}
              run: pnpm dlx changelogen

            - name: Commit version bump and changelog
              if: ${{ inputs.release && inputs.create_tag }}
              env:
                  VERSION: ${{ steps.bump.outputs.version }}
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git add package.json src-tauri/Cargo.toml src-tauri/tauri.conf.json CHANGELOG.md
                  git commit -m "chore(release): v$VERSION"
                  git tag v$VERSION

            - name: Push changes
              if: ${{ inputs.release && inputs.create_tag }}
              run: |
                  git push
                  git push --tags

            - name: Decide checkout ref
              id: checkout_ref
              env:
                  VERSION: ${{ steps.bump.outputs.version || steps.version_tag.outputs.version || steps.version_pkg.outputs.version }}
              run: |
                  REF="$GITHUB_REF"
                  if [[ "$GITHUB_REF" == refs/tags/* ]]; then
                    REF="$GITHUB_REF"
                  elif [[ "${{ inputs.release }}" == "true" && "${{ inputs.create_tag }}" == "true" ]]; then
                    REF="refs/tags/v$VERSION"
                  elif [[ "${{ inputs.release }}" == "true" && "${{ inputs.create_tag }}" != "true" ]]; then
                    TAG="v$VERSION"
                    if git rev-parse "$TAG" >/dev/null 2>&1; then
                      REF="refs/tags/$TAG"
                    else
                      echo "Tag $TAG not found. Create it first or run with create_tag=true."
                      exit 1
                    fi
                  fi
                  echo "ref=$REF" >> $GITHUB_OUTPUT

    build-wxt:
        needs: version
        if: ${{ needs.version.outputs.skip_tag_jobs != 'true' }}
        runs-on: ubuntu-latest
        outputs:
            chrome-zip: ${{ steps.artifacts.outputs.chrome }}
            firefox-zip: ${{ steps.artifacts.outputs.firefox }}
            sources-zip: ${{ steps.artifacts.outputs.sources }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  fetch-tags: true
                  ref: ${{ needs.version.outputs.checkout_ref }}

            - uses: jdx/mise-action@v3
              with:
                  cache: true
                  cache_key_prefix: 'mise-v1'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build WXT extensions
              run: |
                  pnpm run zip
                  pnpm run zip:firefox

            - name: List artifacts
              id: artifacts
              run: |
                  VERSION="${{ needs.version.outputs.version }}"
                  CHROME=$(find .output -name "*-$VERSION-chrome.zip" | head -1)
                  FIREFOX=$(find .output -name "*-$VERSION-firefox.zip" | head -1)
                  SOURCES=$(find .output -name "*-$VERSION-sources.zip" | head -1)
                  echo "chrome=$CHROME" >> $GITHUB_OUTPUT
                  echo "firefox=$FIREFOX" >> $GITHUB_OUTPUT
                  echo "sources=$SOURCES" >> $GITHUB_OUTPUT
                  echo "Chrome: $CHROME"
                  echo "Firefox: $FIREFOX"
                  echo "Sources: $SOURCES"

            - name: Upload WXT artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: wxt-zips
                  path: |
                      ${{ steps.artifacts.outputs.chrome }}
                      ${{ steps.artifacts.outputs.firefox }}
                      ${{ steps.artifacts.outputs.sources }}
                  if-no-files-found: error

    build-tauri-desktop:
        needs: version
        if: ${{ needs.version.outputs.skip_tag_jobs != 'true' }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: 'macos-latest'
                      target: 'aarch64-apple-darwin'
                      arch: 'arm64'
                    - platform: 'macos-latest'
                      target: 'x86_64-apple-darwin'
                      arch: 'x64'
                    - platform: 'windows-latest'
                      target: 'x86_64-pc-windows-msvc'
                      arch: 'x64'
                    - platform: 'windows-latest'
                      target: 'i686-pc-windows-msvc'
                      arch: 'x86'
                    - platform: 'windows-latest'
                      target: 'aarch64-pc-windows-msvc'
                      arch: 'arm64'
                    - platform: 'ubuntu-22.04'
                      target: 'x86_64-unknown-linux-gnu'
                      arch: 'x64'
        runs-on: ${{ matrix.platform }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  fetch-tags: true
                  ref: ${{ needs.version.outputs.checkout_ref }}

            - uses: jdx/mise-action@v3
              with:
                  cache: true
                  cache_key_prefix: 'mise-v1'

            - name: Add Rust target
              run: rustup target add ${{ matrix.target }}

            - name: Rust cache
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: './src-tauri -> target'

            - name: Install system dependencies (ubuntu only)
              if: matrix.platform == 'ubuntu-22.04'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build Tauri desktop
              run: pnpm exec tauri build --target ${{ matrix.target }}
              env:
                  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
                  TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

            - name: Upload macOS artifacts
              if: startsWith(matrix.platform, 'macos-')
              uses: actions/upload-artifact@v4
              with:
                  name: tauri-desktop-${{ matrix.target }}
                  path: |
                      src-tauri/target/**/bundle/dmg/*.dmg
                      src-tauri/target/**/bundle/macos/*.app.tar.gz
                  if-no-files-found: error

            - name: Upload Windows artifacts
              if: matrix.platform == 'windows-latest'
              uses: actions/upload-artifact@v4
              with:
                  name: tauri-desktop-${{ matrix.target }}
                  path: |
                      src-tauri/target/**/bundle/msi/*.msi
                      src-tauri/target/**/bundle/nsis/*.exe
                  if-no-files-found: error

            - name: Upload Linux artifacts
              if: matrix.platform == 'ubuntu-22.04'
              uses: actions/upload-artifact@v4
              with:
                  name: tauri-desktop-${{ matrix.target }}
                  path: |
                      src-tauri/target/**/bundle/deb/*.deb
                      src-tauri/target/**/bundle/rpm/*.rpm
                      src-tauri/target/**/bundle/appimage/*.AppImage
                  if-no-files-found: error

    build-tauri-android:
        needs: version
        if: ${{ needs.version.outputs.skip_tag_jobs != 'true' }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - target: aarch64
                      rust_triple: aarch64-linux-android
                    - target: armv7
                      rust_triple: armv7-linux-androideabi
                    - target: i686
                      rust_triple: i686-linux-android
                    - target: x86_64
                      rust_triple: x86_64-linux-android
        runs-on: ubuntu-latest
        env:
            ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
            ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
            ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
            ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  fetch-tags: true
                  ref: ${{ needs.version.outputs.checkout_ref }}

            - uses: jdx/mise-action@v3
              with:
                  cache: true
                  cache_key_prefix: 'mise-v1'

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: Install NDK
              run: sdkmanager "ndk;$NDK_VERSION"

            - name: Cache Android NDK
              uses: actions/cache@v4
              with:
                  path: /usr/local/lib/android/sdk/ndk/${{ env.NDK_VERSION }}
                  key: ndk-${{ runner.os }}-${{ env.NDK_VERSION }}

            - name: Add Android Rust targets
              run: rustup target add ${{ matrix.rust_triple }}

            - name: Rust cache
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: './src-tauri -> target'
                  cache-on-failure: true

            - name: Configure Android signing
              if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
              run: |
                  printf '%s' "$ANDROID_KEYSTORE_BASE64" | base64 -d > src-tauri/gen/android/release.keystore
                  cat > src-tauri/gen/android/key.properties <<'EOF'
                  storeFile=release.keystore
                  storePassword=$ANDROID_KEYSTORE_PASSWORD
                  keyAlias=$ANDROID_KEY_ALIAS
                  keyPassword=$ANDROID_KEY_PASSWORD
                  EOF

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build Tauri Android
              run: |
                  export NDK_HOME="$ANDROID_HOME/ndk/$NDK_VERSION"
                  export ANDROID_HOME="/usr/local/lib/android/sdk"
                  pnpm exec tauri android build --split-per-abi --target ${{ matrix.target }}

            - name: Upload Android artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: android-apk-${{ matrix.target }}
                  path: src-tauri/gen/android/app/build/outputs/apk/**/*.apk
                  if-no-files-found: error

    create-release:
        needs: [version, build-wxt, build-tauri-desktop, build-tauri-android]
        if: ${{ needs.version.outputs.skip_tag_jobs != 'true' && (startsWith(github.ref, 'refs/tags/') || (inputs.release && !inputs.dry_run)) }}
        permissions:
            contents: write
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  fetch-tags: true

            - uses: jdx/mise-action@v3
              with:
                  cache: true
                  cache_key_prefix: 'mise-v1'

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: ./artifacts
                  pattern: '*'
                  merge-multiple: true

            - name: Generate release notes (tag to tag)
              run: |
                  CURRENT_TAG="${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', needs.version.outputs.version) }}"
                  PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v' | grep -v "^${CURRENT_TAG}$" | head -n 1)
                  if [ -n "$PREV_TAG" ]; then
                    pnpm dlx changelogen --from "$PREV_TAG" --to "$CURRENT_TAG" --no-output > release_notes.md
                  else
                    echo "## Shamela EPUB Exporter ${CURRENT_TAG}

                    ### WXT Extension
                    - Chrome: Upload to Chrome Web Store
                    - Firefox: Upload to Firefox Addon Store
                    - Source code: For Firefox review

                    ### Tauri Desktop
                    - macOS (ARM64 & Intel): .dmg files
                    - Windows: .msi and .exe installers
                    - Linux: .AppImage and .deb packages

                    ### Tauri Android
                    - APKs for ARM64, ARMv7, x86_64 architectures

                    See assets below for all downloads." > release_notes.md
                  fi

            - name: Create GitHub Release using gh CLI
              env:
                  GH_TOKEN: ${{ github.token }}
                  VERSION: ${{ needs.version.outputs.version }}
              run: |
                  gh release create v$VERSION \
                    --title "v$VERSION" \
                    --notes-file release_notes.md \
                    ./artifacts/**/*

    submit-stores:
        needs: [version, build-wxt, create-release]
        if: ${{ needs.version.outputs.skip_tag_jobs != 'true' && (startsWith(github.ref, 'refs/tags/') || (inputs.release && !inputs.dry_run)) }}
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: jdx/mise-action@v3
              with:
                  cache: true
                  cache_key_prefix: 'mise-v1'

            - name: Download WXT artifacts
              uses: actions/download-artifact@v4
              with:
                  name: wxt-zips
                  path: .output

            - name: Submit to Chrome Web Store
              continue-on-error: true
              run: |
                  VERSION="${{ needs.version.outputs.version }}"
                  CHROME_ZIP=$(find .output -name "*-$VERSION-chrome.zip")
                  pnpm dlx wxt submit --chrome-zip "$CHROME_ZIP"
              env:
                  CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
                  CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
                  CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
                  CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}

            - name: Submit to Firefox Addon Store
              continue-on-error: true
              run: |
                  VERSION="${{ needs.version.outputs.version }}"
                  FIREFOX_ZIP=$(find .output -name "*-$VERSION-firefox.zip")
                  SOURCES_ZIP=$(find .output -name "*-$VERSION-sources.zip")
                  pnpm dlx wxt submit \
                    --firefox-zip "$FIREFOX_ZIP" \
                    --firefox-sources-zip "$SOURCES_ZIP"
              env:
                  FIREFOX_EXTENSION_ID: ${{ secrets.FIREFOX_EXTENSION_ID }}
                  FIREFOX_JWT_ISSUER: ${{ secrets.FIREFOX_JWT_ISSUER }}
                  FIREFOX_JWT_SECRET: ${{ secrets.FIREFOX_JWT_SECRET }}
